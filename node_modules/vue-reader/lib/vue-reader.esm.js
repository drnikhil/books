import{defineComponent as e,getCurrentInstance as t,h as o,toRefs as n,ref as a,watch as r,onMounted as i,onBeforeUnmount as s,version as l,Transition as c,reactive as u}from"vue-demi";import p from"epubjs";function d(e,t){void 0===t&&(t={});var o=t.insertAt;if(e&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],a=document.createElement("style");a.type="text/css","top"===o&&n.firstChild?n.insertBefore(a,n.firstChild):n.appendChild(a),a.styleSheet?a.styleSheet.cssText=e:a.appendChild(document.createTextNode(e))}}d(".reader{inset:50px 50px 20px;position:absolute}.viewHolder{height:100%;position:relative;width:100%}#viewer{height:100%}");var b=e({name:"EpubView",model:{prop:"location",event:"update:location"},emits:{"update:location":e=>!0,select:(e,t)=>!0,keyup:e=>!0},props:{url:{required:!0},location:{},tocChanged:{type:Function},getRendition:{type:Function},epubInitOptions:{type:Object,default:()=>({})},epubOptions:{type:Object,default:()=>({})}},setup(e,c){const{emit:u,slots:d,expose:b}=c,f=t(),v=o.bind(f),{url:g,location:h}=n(e),{tocChanged:x,getRendition:m,epubInitOptions:w,epubOptions:y}=e,k=a(null),A=a([]),B=a(!1);let E=null,C=null;const L=async()=>{E&&E.destroy(),g.value&&(E=p(g.value,w),E.loaded.navigation.then((({toc:e})=>{B.value=!0,A.value=e,x&&x(e),T()})))},T=()=>{const e=k.value||f?.refs?.viewer;C=E.renderTo(e,{width:"100%",height:"100%",...y}),X(),m&&m(C),"string"==typeof h?.value||"number"==typeof h?.value?C.display(h.value):A.value.length>0&&A?.value[0]?.href?C.display(A.value[0].href):C.display()},R=e=>{"next"===e?S():"prev"===e&&P()},X=()=>{C&&(C.on("rendered",((e,t)=>{var o,n;t?.iframe?.contentWindow.focus(),y?.flow?.includes("scrolled")||function(e,t){let o,n=0;e.addEventListener("wheel",(e=>{e.ignore||(e.ignore=!0,clearTimeout(o),n+=e.deltaY,o=setTimeout((()=>{if(Math.abs(n)>=750){let e=Math.sign(n)>0?"next":"prev";t(e),n=0}n=0}),50))}))}(t.document,R),function(e,t){let o,n,a;e.addEventListener("touchstart",(e=>{e.ignore||(e.ignore=!0,o=e.changedTouches[0].pageX,n=e.changedTouches[0].pageY,a=Date.now())}),!1),e.addEventListener("touchend",(r=>{if(r.ignore)return;r.ignore=!0;const i=r.changedTouches[0].pageX-o,s=r.changedTouches[0].pageY-n;Date.now()-a<=500&&(Math.abs(i)>=50&&Math.abs(s)<=200?t(i<0?"prev":"next"):Math.abs(s)>=50&&Math.abs(i)<=200?t(s<0?"up":"down"):(e?.defaultView?.getSelection()?.removeAllRanges(),e.dispatchEvent(new MouseEvent("click",{clientX:o,clientY:n})),r.preventDefault()))}),!1)}(t.document,R),o=t.document,n=R,o.addEventListener("keyup",(e=>{"ArrowUp"===e.key||"ArrowRight"===e.key?n("next"):"ArrowDown"!==e.key&&"ArrowLeft"!==e.key||n("prev")}),!1)})),C.on("locationChanged",z),C.on("displayError",(e=>console.error("error rendering book",e))),C.on("selected",((e,t)=>u("select",e,t))),C.on("keyup",(e=>u("keyPress",e))))},z=e=>{const t=e.start;h?.value!==t&&u("update:location",t)};h&&r(h,((e,t=1e3)=>{let o;return function(...n){clearTimeout(o),o=setTimeout((()=>{o=null,e(...n)}),t)}})(((e,t)=>{e&&e===t||("string"==typeof e&&C?.display(e),"number"==typeof e&&C?.display(e))})),{immediate:!0}),r(g,(()=>{L()}));const S=()=>{C?.next()},P=()=>{C?.prev()},V=e=>{"string"==typeof e&&C.display(e),"number"==typeof e&&C.display(e)};if(i((()=>{L()})),s((()=>{E?.destroy()})),b)b({nextPage:S,prevPage:P,setLocation:V});else{(e=>{if(!f)throw new Error("expose should be called in setup().");const t=Object.keys(e);t.forEach((t=>{f.proxy[t]=e[t]})),s((()=>{t.forEach((e=>{f.proxy[e]=void 0}))}))})({nextPage:S,prevPage:P,setLocation:V})}return()=>v("div",{class:"reader"},[v("div",{class:"viewHolder"},[v("div",{ref:parseFloat(l)>=2.7?k:"viewer",class:"view",id:"viewer",attrs:{id:"viewer"},style:{display:B.value?null:"none"}}),!B.value&&v("div",d.loadingView?.())])])}});d('.container{height:100%;overflow:hidden;position:relative}.containerExpanded{-webkit-transform:translateX(256px);transform:translateX(256px)}.readerArea{background-color:#fff;height:100%;position:relative;-webkit-transition:all .3s ease;transition:all .3s ease;width:100%;z-index:1}.container .titleArea{color:#999;left:50px;overflow:hidden;position:absolute;right:50px;text-align:center;text-overflow:ellipsis;top:20px;white-space:nowrap}.tocBackground{left:256px;right:0;z-index:1}.tocArea,.tocBackground{bottom:0;position:absolute;top:0}.tocArea{-webkit-overflow-scrolling:touch;background:#f2f2f2;left:0;overflow-y:auto;padding:10px 0;width:256px;z-index:0}.tocArea::-webkit-scrollbar{height:5px;width:5px}.tocArea::-webkit-scrollbar-thumb:vertical{background-color:rgba(0,0,0,.1);border-radius:.5rem;height:5px}.tocArea .tocAreaButton{-webkit-appearance:none;-moz-appearance:none;appearance:none;background:none;border:none;border-bottom:1px solid #ddd;-webkit-box-sizing:border-box;box-sizing:border-box;color:#aaa;cursor:pointer;display:block;font-family:sans-serif;font-size:.9em;outline:none;padding:.9em 1em;position:relative;text-align:left;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:100%}.tocArea .tocAreaButton:hover{background:rgba(0,0,0,.05)}.tocArea .tocAreaButton:active{background:rgba(0,0,0,.1)}.tocArea .active{border-bottom:2px solid #1565c0;color:#1565c0}.tocArea .tocAreaButton .expansion{background-color:#a2a5b4;cursor:pointer;right:12px;top:50%;-webkit-transform:translateY(-50%);transform:translateY(-50%);width:10px}.tocArea .tocAreaButton .expansion,.tocArea .tocAreaButton .expansion:after,.tocArea .tocAreaButton .expansion:before{position:absolute;-webkit-transition:top .3s ease-in-out,-webkit-transform .3s ease-in-out;transition:top .3s ease-in-out,-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out,top .3s ease-in-out;transition:transform .3s ease-in-out,top .3s ease-in-out,-webkit-transform .3s ease-in-out}.tocArea .tocAreaButton .expansion:after,.tocArea .tocAreaButton .expansion:before{background-color:currentcolor;border-radius:2px;content:"";height:2px;width:6px}.tocArea .tocAreaButton .expansion:before{-webkit-transform:rotate(-45deg) translateX(2.5px);transform:rotate(-45deg) translateX(2.5px)}.tocArea .tocAreaButton .expansion:after{-webkit-transform:rotate(45deg) translateX(-2.5px);transform:rotate(45deg) translateX(-2.5px)}.tocArea .tocAreaButton .open:before{-webkit-transform:rotate(45deg) translateX(2.5px);transform:rotate(45deg) translateX(2.5px)}.tocArea .tocAreaButton .open:after{-webkit-transform:rotate(-45deg) translateX(-2.5px);transform:rotate(-45deg) translateX(-2.5px)}.tocButton{background:none;border:none;border-radius:2px;cursor:pointer;height:32px;left:10px;outline:none;position:absolute;top:10px;width:32px}.tocButtonBar{background:#ccc;height:2px;left:50%;margin:-1px -30%;position:absolute;top:50%;-webkit-transition:all .5s ease;transition:all .5s ease;width:60%}.tocButtonExpanded{background:#f2f2f2}.arrow{-webkit-appearance:none;-moz-appearance:none;appearance:none;background:none;border:none;color:#e2e2e2;cursor:pointer;font-family:arial,sans-serif;font-size:64px;font-weight:400;margin-top:-32px;outline:none;padding:0 10px;position:absolute;top:50%;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.arrow:hover{color:#777}.arrow:disabled{color:#e2e2e2;cursor:not-allowed}.prev{left:1px}.next{right:1px}.loadingView{color:#ccc;left:10%;margin-top:-.5em;position:absolute;right:10%;text-align:center;top:50%}');const f=e({name:"TocComponent",props:{toc:{type:Array,default:()=>[]},current:{type:[String,Number],default:""},setLocation:{type:Function,required:!0},isSubmenu:{type:Boolean,default:!1,required:!1}},setup(e){const a=t(),r=o.bind(a),{setLocation:i,isSubmenu:s}=e,{toc:l,current:u}=n(e);return()=>r("div",null,l.value.map(((e,t)=>r("div",{key:t},[r("button",{class:["tocAreaButton",e.href===u.value?"active":""],on:{click:()=>{e.subitems.length>0?(e.expansion=!e.expansion,i(e.href,!1)):i(e.href)}},onClick:()=>{e.subitems.length>0?(e.expansion=!e.expansion,i(e.href,!1)):i(e.href)}},[`${s?" ".repeat(4):""}${e.label}`,e.subitems&&e.subitems.length>0&&r("div",{class:(e.expansion?"open":"")+" expansion"})]),e.subitems&&e.subitems.length>0&&r(c,{name:"collapse-transition"},{default:()=>r("div",{style:{display:e.expansion?void 0:"none"}},r(f,{toc:e.subitems,current:u.value,setLocation:i,isSubmenu:!0,attrs:{toc:l.value,current:u.value,setLocation:i,isSubmenu:!0}}))})]))))}});var v=e({name:"VueReader",props:{url:{required:!0},title:String,showToc:{type:Boolean,default:!0},tocChanged:{type:Function},getRendition:{type:Function}},setup(e,r){const{emit:i,slots:c,expose:p,attrs:d}=r,v=t(),g=o.bind(v),h=a(null),x=a(null),m=a(""),{tocChanged:w,getRendition:y}=e,{title:k,url:A,showToc:B}=n(e),E=u({toc:[],expandedToc:!1}),{toc:C,expandedToc:L}=n(E),T=a(""),R=()=>{L.value=!L.value},X=e=>{C.value=e.map((e=>({...e,expansion:!1}))),w&&w(e)},z=e=>{y&&y(e),e.on("relocated",(e=>{x.value=e}));const t=e.book;t.ready.then((()=>{const e=t.package.metadata;T.value=e.title}))},S=(e,t=!0)=>{const o=h.value||v?.refs.epubRef;o?.setLocation(e),m.value=e,L.value=!t},P=()=>{const e=h.value||v?.refs.epubRef;e?.nextPage()},V=()=>{const e=h.value||v?.refs.epubRef;e?.prevPage()};if(p)p({setLocation:S,next:P,pre:V});else{(e=>{if(!v)throw new Error("expose should be called in setup().");const t=Object.keys(e);t.forEach((t=>{v.proxy[t]=e[t]})),s((()=>{t.forEach((e=>{v.proxy[e]=void 0}))}))})({setLocation:S,next:P,pre:V})}return()=>g("div",{class:"container"},[g("div",{class:["readerArea",{containerExpanded:L.value}]},[B.value&&g("button",{class:["tocButton",{tocButtonExpanded:L.value}],type:"button",on:{click:R},onClick:R},[g("span",{class:"tocButtonBar",style:"top: 35%"}),g("span",{class:"tocButtonBar",style:"top: 66%"})]),g("div",{class:"titleArea",title:T.value},c.title?c.title?.():k.value||T.value),g(b,{ref:parseFloat(l)<2.7?"epubRef":h,url:A.value,tocChanged:X,getRendition:z,...d,attrs:{url:A.value,tocChanged:X,getRendition:z,...d},on:{...r.listeners}},{loadingView:()=>g("div",{class:"loadingView"},c.loadingView?c.loadingView?.():"Loading...")}),g("button",{class:"arrow pre",on:{click:V},onClick:V,domProps:{disabled:x.value?.atStart},disabled:x.value?.atStart},"‹"),g("button",{class:"arrow next",on:{click:P},onClick:P,domProps:{disabled:x.value?.atEnd},disabled:x.value?.atEnd},"›")]),B.value&&g("div",[g("div",{class:"tocArea"},g(f,{toc:C.value,current:m.value,setLocation:S,attrs:{toc:C.value,current:m.value,setLocation:S}})),L.value&&g("div",{class:["tocBackground"],onClick:R,on:{click:R}})])])}});export{b as EpubView,v as VueReader,v as default};
